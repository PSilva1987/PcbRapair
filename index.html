<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Web Player</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .container {
            max-width: 500px;
            width: 100%;
            text-align: center;
        }
        
        h1 {
            color: #1DB954;
            margin-bottom: 30px;
        }
        
        .player {
            background-color: #181818;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .album-cover {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            margin: 0 auto 20px;
            object-fit: cover;
            display: block;
        }
        
        .track-info {
            margin-bottom: 25px;
        }
        
        .track-name {
            font-size: 22px;
            margin: 0 0 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .artist-name {
            color: #b3b3b3;
            margin: 0;
            font-size: 16px;
        }
        
        .progress-container {
            margin-bottom: 25px;
        }
        
        .progress-bar {
            height: 4px;
            background-color: #535353;
            border-radius: 2px;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #1DB954;
            width: 0%;
        }
        
        .time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #b3b3b3;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .btn-play {
            background-color: #1DB954;
            width: 50px;
            height: 50px;
            font-size: 24px;
        }
        
        .btn.active {
            color: #1DB954;
        }
        
        .btn:disabled {
            color: #535353;
            cursor: not-allowed;
        }
        
        .auth-btn {
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 500px;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            margin-top: 20px;
        }
        
        .status {
            margin-top: 20px;
            color: #b3b3b3;
            font-size: 14px;
        }
        
        .device-id {
            font-family: monospace;
            background-color: #282828;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify Web Player</h1>
        
        <div id="auth-section">
            <button id="auth-btn" class="auth-btn">Login com Spotify</button>
        </div>
        
        <div id="player-section" class="player" style="display: none;">
            <img id="album-cover" class="album-cover" src="https://via.placeholder.com/200" alt="Album Cover">
            
            <div class="track-info">
                <h2 id="track-name" class="track-name">Nenhuma m√∫sica tocando</h2>
                <p id="artist-name" class="artist-name">‚Äî</p>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="time">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            
            <div class="controls">
                <button id="shuffle-btn" class="btn" title="Embaralhar">üîÄ</button>
                <button id="prev-btn" class="btn" title="Anterior">‚èÆ</button>
                <button id="play-btn" class="btn btn-play" title="Play/Pause">‚ñ∂</button>
                <button id="next-btn" class="btn" title="Pr√≥xima">‚è≠</button>
                <button id="repeat-btn" class="btn" title="Repetir">üîÅ</button>
            </div>
            
            <div class="status">
                <p>Dispositivo conectado:</p>
                <p id="device-id" class="device-id">Aguardando conex√£o...</p>
            </div>
        </div>
    </div>

    <script>
        // 1. Configura√ß√£o - ATEN√á√ÉO A ESTA PARTE!
        const clientId = 'a320634e6ebf4bb58de016369cf5b1a1'; // Substitua pelo seu Client ID do Spotify Dashboard
        const redirectUri = 'https://psilva1987.github.io/PcbRapair/'; // DEVE SER IGUAL AO CONFIGURADO NO SPOTIFY DASHBOARD
        
        // 2. Elementos DOM
        const authSection = document.getElementById('auth-section');
        const authBtn = document.getElementById('auth-btn');
        const playerSection = document.getElementById('player-section');
        const albumCover = document.getElementById('album-cover');
        const trackName = document.getElementById('track-name');
        const artistName = document.getElementById('artist-name');
        const progress = document.getElementById('progress');
        const currentTime = document.getElementById('current-time');
        const duration = document.getElementById('duration');
        const playBtn = document.getElementById('play-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const deviceId = document.getElementById('device-id');
        
        // 3. Estado do player
        const playerState = {
            accessToken: null,
            deviceId: null,
            player: null,
            isPlaying: false,
            currentTrack: null,
            progressInterval: null,
            position: 0,
            trackDuration: 0,
            isShuffled: false,
            repeatMode: 0 // 0=off, 1=context, 2=track
        };
        
        // 4. Inicializa√ß√£o
        function init() {
            // Verificar se h√° token na URL (ap√≥s redirecionamento)
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (accessToken) {
                // Limpar a URL
                history.replaceState(null, null, window.location.pathname);
                
                playerState.accessToken = accessToken;
                authSection.style.display = 'none';
                playerSection.style.display = 'block';
                initializePlayer();
            }
            
            setupEventListeners();
        }
        
        // 5. Configurar listeners
        function setupEventListeners() {
            authBtn.addEventListener('click', authenticate);
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', previousTrack);
            nextBtn.addEventListener('click', nextTrack);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);
        }
        
        // 6. Autentica√ß√£o com Spotify
        function authenticate() {
            const scopes = [
                'streaming',
                'user-read-email',
                'user-read-private',
                'user-read-playback-state',
                'user-modify-playback-state'
            ];
            
            const authUrl = new URL('https://accounts.spotify.com/authorize');
            
            // Par√¢metros OAuth 2.0
            const params = {
                response_type: 'token',
                client_id: clientId,
                scope: scopes.join(' '),
                redirect_uri: redirectUri,
                show_dialog: 'false'
            };
            
            // Adicionar par√¢metros √† URL
            Object.keys(params).forEach(key => {
                authUrl.searchParams.append(key, params[key]);
            });
            
            // Redirecionar para p√°gina de autentica√ß√£o
            window.location.href = authUrl.toString();
        }
        
        // 7. Inicializar o Web Playback SDK
        function initializePlayer() {
            // Carregar o SDK dinamicamente
            const script = document.createElement('script');
            script.src = 'https://sdk.scdn.co/spotify-player.js';
            script.onload = () => {
                window.onSpotifyWebPlaybackSDKReady = () => {
                    playerState.player = new Spotify.Player({
                        name: 'Meu Web Player',
                        getOAuthToken: cb => { cb(playerState.accessToken); },
                        volume: 0.5
                    });
                    
                    // Configurar listeners
                    setupPlayerListeners();
                    
                    // Conectar ao player
                    playerState.player.connect().then(success => {
                        if (success) {
                            deviceId.textContent = 'Conectando...';
                        }
                    });
                };
            };
            document.body.appendChild(script);
        }
        
        // 8. Configurar listeners do player
        function setupPlayerListeners() {
            // Quando o player estiver pronto
            playerState.player.addListener('ready', ({ device_id }) => {
                playerState.deviceId = device_id;
                deviceId.textContent = device_id;
                transferPlayback(device_id);
            });
            
            // Quando o estado do player mudar
            playerState.player.addListener('player_state_changed', state => {
                if (!state) {
                    // Nenhuma m√∫sica tocando
                    playerState.isPlaying = false;
                    playerState.currentTrack = null;
                    updatePlayerUI();
                    return;
                }
                
                playerState.isPlaying = !state.paused;
                playerState.currentTrack = state.track_window.current_track;
                playerState.position = state.position;
                playerState.trackDuration = state.duration;
                playerState.isShuffled = state.shuffle;
                playerState.repeatMode = state.repeat_mode;
                
                updatePlayerUI();
                updateProgressBar();
                updateControlStates();
            });
            
            // Tratamento de erros
            playerState.player.addListener('authentication_error', ({ message }) => {
                console.error('Erro de autentica√ß√£o:', message);
                alert('Erro de autentica√ß√£o: ' + message);
            });
            
            playerState.player.addListener('account_error', ({ message }) => {
                console.error('Erro de conta:', message);
            });
            
            playerState.player.addListener('playback_error', ({ message }) => {
                console.error('Erro de reprodu√ß√£o:', message);
            });
            
            playerState.player.addListener('initialization_error', ({ message }) => {
                console.error('Erro de inicializa√ß√£o:', message);
            });
            
            playerState.player.addListener('not_ready', ({ device_id }) => {
                console.log('Dispositivo offline:', device_id);
                deviceId.textContent = `${device_id} (offline)`;
            });
        }
        
        // 9. Transferir reprodu√ß√£o para este dispositivo
        function transferPlayback(deviceId) {
            fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    device_ids: [deviceId],
                    play: false
                })
            }).catch(error => {
                console.error('Erro ao transferir reprodu√ß√£o:', error);
            });
        }
        
        // 10. Controles do player
        function togglePlay() {
            if (playerState.isPlaying) {
                playerState.player.pause();
            } else {
                playerState.player.resume();
            }
        }
        
        function previousTrack() {
            playerState.player.previousTrack();
        }
        
        function nextTrack() {
            playerState.player.nextTrack();
        }
        
        function toggleShuffle() {
            const newShuffleState = !playerState.isShuffled;
            
            fetch(`https://api.spotify.com/v1/me/player/shuffle?state=${newShuffleState}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`
                }
            }).then(() => {
                playerState.isShuffled = newShuffleState;
                shuffleBtn.classList.toggle('active', newShuffleState);
            });
        }
        
        function toggleRepeat() {
            let newRepeatMode;
            
            switch(playerState.repeatMode) {
                case 0: newRepeatMode = 1; break; // off ‚Üí context
                case 1: newRepeatMode = 2; break; // context ‚Üí track
                case 2: newRepeatMode = 0; break; // track ‚Üí off
            }
            
            fetch(`https://api.spotify.com/v1/me/player/repeat?state=${getRepeatStateString(newRepeatMode)}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`
                }
            }).then(() => {
                playerState.repeatMode = newRepeatMode;
                updateRepeatButton();
            });
        }
        
        function getRepeatStateString(mode) {
            switch(mode) {
                case 0: return 'off';
                case 1: return 'context';
                case 2: return 'track';
            }
        }
        
        // 11. Atualizar UI
        function updatePlayerUI() {
            if (playerState.currentTrack) {
                trackName.textContent = playerState.currentTrack.name;
                artistName.textContent = playerState.currentTrack.artists.map(a => a.name).join(', ');
                albumCover.src = playerState.currentTrack.album.images[0]?.url || 'https://via.placeholder.com/200';
                playBtn.textContent = playerState.isPlaying ? '‚è∏' : '‚ñ∂';
            } else {
                trackName.textContent = 'Nenhuma m√∫sica tocando';
                artistName.textContent = '‚Äî';
                albumCover.src = 'https://via.placeholder.com/200';
                playBtn.textContent = '‚ñ∂';
            }
        }
        
        function updateProgressBar() {
            if (playerState.progressInterval) {
                clearInterval(playerState.progressInterval);
            }
            
            if (!playerState.trackDuration) {
                progress.style.width = '0%';
                currentTime.textContent = '0:00';
                duration.textContent = '0:00';
                return;
            }
            
            const formatTime = (ms) => {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            };
            
            const update = () => {
                const progressPercent = (playerState.position / playerState.trackDuration) * 100;
                progress.style.width = `${progressPercent}%`;
                currentTime.textContent = formatTime(playerState.position);
                duration.textContent = formatTime(playerState.trackDuration);
                
                if (playerState.isPlaying && playerState.position < playerState.trackDuration) {
                    playerState.position += 1000;
                }
            };
            
            update();
            
            if (playerState.isPlaying) {
                playerState.progressInterval = setInterval(update, 1000);
            }
        }
        
        function updateControlStates() {
            shuffleBtn.classList.toggle('active', playerState.isShuffled);
            updateRepeatButton();
        }
        
        function updateRepeatButton() {
            repeatBtn.classList.remove('active');
            
            switch(playerState.repeatMode) {
                case 0:
                    repeatBtn.textContent = 'üîÅ';
                    break;
                case 1:
                    repeatBtn.textContent = 'üîÅ';
                    repeatBtn.classList.add('active');
                    break;
                case 2:
                    repeatBtn.textContent = 'üîÇ';
                    repeatBtn.classList.add('active');
                    break;
            }
        }
        
        // 12. Inicializar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
