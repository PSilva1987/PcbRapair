<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Web Controller</title>
    <style>
        :root {
            --primary: #1DB954;
            --dark: #191414;
            --light: #FFFFFF;
            --gray: #282828;
            --light-gray: #B3B3B3;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--dark);
            color: var(--light);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        header {
            background-color: var(--gray);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .auth-btn {
            background-color: var(--primary);
            color: var(--dark);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .auth-btn:hover {
            transform: scale(1.05);
        }
        
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--gray);
            padding: 1rem;
            overflow-y: auto;
            display: none; /* Inicialmente oculto */
        }
        
        .content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .player-container {
            background-color: var(--gray);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .progress-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #444;
        }
        
        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 200px;
        }
        
        .track-cover {
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
        
        .track-info {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-info h4 {
            margin: 0;
            font-size: 1rem;
        }
        
        .track-info p {
            margin: 0;
            color: var(--light-gray);
            font-size: 0.8rem;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        
        .control-btn:hover {
            color: var(--primary);
        }
        
        .play-btn {
            background-color: var(--primary);
            color: var(--dark);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .player-extra {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 200px;
            justify-content: flex-end;
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .volume-slider {
            width: 80px;
        }
        
        .device-status {
            padding: 0.5rem;
            background-color: rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mensagens de status */
        .status-message {
            padding: 1rem;
            text-align: center;
            color: var(--light-gray);
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .player-info, .player-extra {
                display: none;
            }
            
            .player-controls {
                width: 100%;
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Spotify Web Controller</div>
        <button id="auth-btn" class="auth-btn">Conectar ao Spotify</button>
    </header>
    
    <div class="main-container">
        <div class="content">
            <div id="status-message" class="status-message">
                Conecte-se ao Spotify para come√ßar
            </div>
        </div>
    </div>
    
    <div class="player-container">
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        
        <div class="player-info">
            <img id="track-cover" class="track-cover" src="https://via.placeholder.com/50" alt="Capa do √°lbum">
            <div class="track-info">
                <h4 id="track-name">Nenhuma m√∫sica tocando</h4>
                <p id="track-artist">‚Äî</p>
            </div>
        </div>
        
        <div class="player-controls">
            <button id="shuffle-btn" class="control-btn" title="Embaralhar">üîÄ</button>
            <button id="prev-btn" class="control-btn" title="Anterior">‚èÆ</button>
            <button id="play-btn" class="control-btn play-btn" title="Play/Pause">‚ñ∂</button>
            <button id="next-btn" class="control-btn" title="Pr√≥xima">‚è≠</button>
            <button id="repeat-btn" class="control-btn" title="Repetir">üîÅ</button>
        </div>
        
        <div class="player-extra">
            <div class="volume-container">
                <span>üîà</span>
                <input type="range" id="volume-slider" class="volume-slider" min="0" max="1" step="0.01" value="0.5">
            </div>
            <div id="device-status" class="device-status">
                Dispositivo: N√£o conectado
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Spotify
        const clientId = 'a320634e6ebf4bb58de016369cf5b1a1'; // Substitua pelo seu Client ID
        const redirectUri = window.location.href.split('https://psilva1987.github.io/PcbRapair')[0]; // URL atual sem par√¢metros
        
        // Elementos DOM
        const authBtn = document.getElementById('auth-btn');
        const statusMessage = document.getElementById('status-message');
        const playBtn = document.getElementById('play-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const trackCover = document.getElementById('track-cover');
        const trackName = document.getElementById('track-name');
        const trackArtist = document.getElementById('track-artist');
        const progressBar = document.getElementById('progress-bar');
        const deviceStatus = document.getElementById('device-status');
        
        // Estado do player
        const playerState = {
            accessToken: null,
            deviceId: null,
            player: null,
            isPlaying: false,
            currentTrack: null,
            progressInterval: null,
            volume: 0.5
        };
        
        // Inicializa√ß√£o
        function init() {
            // Verificar token na URL (ap√≥s redirecionamento do Spotify)
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (accessToken) {
                playerState.accessToken = accessToken;
                authBtn.textContent = 'Desconectar';
                setupWebPlaybackSDK();
            }
            
            setupEventListeners();
        }
        
        // Configurar listeners de eventos
        function setupEventListeners() {
            authBtn.addEventListener('click', handleAuthClick);
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrevious);
            nextBtn.addEventListener('click', playNext);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);
            volumeSlider.addEventListener('input', updateVolume);
        }
        
        // Manipulador de autentica√ß√£o
        function handleAuthClick() {
            if (playerState.accessToken) {
                // Desconectar
                if (playerState.player) {
                    playerState.player.disconnect();
                }
                playerState.accessToken = null;
                authBtn.textContent = 'Conectar ao Spotify';
                updateStatus('Desconectado do Spotify');
                updatePlayerUI();
            } else {
                // Conectar
                authenticateWithSpotify();
            }
        }
        
        // Autentica√ß√£o com Spotify
        function authenticateWithSpotify() {
            const scopes = [
                'streaming',
                'user-read-email',
                'user-read-private',
                'user-read-playback-state',
                'user-modify-playback-state'
            ];
            
            const authUrl = new URL('https://accounts.spotify.com/authorize');
            authUrl.searchParams.append('response_type', 'token');
            authUrl.searchParams.append('client_id', clientId);
            authUrl.searchParams.append('scope', scopes.join(' '));
            authUrl.searchParams.append('redirect_uri', redirectUri);
            authUrl.searchParams.append('show_dialog', 'true');
            
            window.location.href = authUrl.toString();
        }
        
        // Configurar Web Playback SDK
        function setupWebPlaybackSDK() {
            updateStatus('Conectando ao Spotify...');
            
            // Carregar o SDK dinamicamente
            const script = document.createElement('script');
            script.src = 'https://sdk.scdn.co/spotify-player.js';
            script.onload = () => {
                window.onSpotifyWebPlaybackSDKReady = () => {
                    playerState.player = new Spotify.Player({
                        name: 'Spotify Web Controller',
                        getOAuthToken: cb => { cb(playerState.accessToken); },
                        volume: playerState.volume
                    });
                    
                    // Configurar listeners do player
                    setupPlayerListeners();
                    
                    // Conectar ao player
                    playerState.player.connect().then(success => {
                        if (success) {
                            updateStatus('Conectado ao Spotify. Inicie a reprodu√ß√£o em algum dispositivo.');
                        }
                    });
                };
            };
            document.body.appendChild(script);
        }
        
        // Configurar listeners do player
        function setupPlayerListeners() {
            // Player pronto
            playerState.player.addListener('ready', ({ device_id }) => {
                playerState.deviceId = device_id;
                updateDeviceStatus(`Dispositivo: ${device_id}`);
                transferPlayback(device_id);
            });
            
            // Estado do player alterado
            playerState.player.addListener('player_state_changed', state => {
                if (!state) return;
                
                playerState.isPlaying = !state.paused;
                playerState.currentTrack = state.track_window.current_track;
                
                updatePlayerUI();
                updateProgress(state.position, state.duration);
                
                // Atualizar estados de shuffle/repeat
                shuffleBtn.classList.toggle('active', state.shuffle);
                updateRepeatButton(state.repeat_mode);
            });
            
            // Erros
            playerState.player.addListener('initialization_error', ({ message }) => {
                console.error('Initialization Error:', message);
                updateStatus(`Erro: ${message}`);
            });
            
            playerState.player.addListener('authentication_error', ({ message }) => {
                console.error('Authentication Error:', message);
                updateStatus(`Erro de autentica√ß√£o: ${message}`);
                playerState.accessToken = null;
                authBtn.textContent = 'Conectar ao Spotify';
            });
            
            playerState.player.addListener('account_error', ({ message }) => {
                console.error('Account Error:', message);
                updateStatus(`Erro de conta: ${message}`);
            });
            
            playerState.player.addListener('playback_error', ({ message }) => {
                console.error('Playback Error:', message);
                updateStatus(`Erro de reprodu√ß√£o: ${message}`);
            });
            
            // Desconectado
            playerState.player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
                updateDeviceStatus(`Dispositivo offline: ${device_id}`);
            });
        }
        
        // Transferir reprodu√ß√£o para este dispositivo
        function transferPlayback(deviceId) {
            fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    device_ids: [deviceId],
                    play: false
                })
            }).then(() => {
                updateStatus('Pronto para reproduzir!');
            }).catch(error => {
                console.error('Error transferring playback:', error);
                updateStatus('Erro ao transferir reprodu√ß√£o');
            });
        }
        
        // Alternar play/pause
        function togglePlay() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            if (playerState.isPlaying) {
                playerState.player.pause().then(() => {
                    updateStatus('Reprodu√ß√£o pausada');
                });
            } else {
                playerState.player.resume().then(() => {
                    updateStatus('Reprodu√ß√£o iniciada');
                });
            }
        }
        
        // M√∫sica anterior
        function playPrevious() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            playerState.player.previousTrack().then(() => {
                updateStatus('Voltando para m√∫sica anterior');
            });
        }
        
        // Pr√≥xima m√∫sica
        function playNext() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            playerState.player.nextTrack().then(() => {
                updateStatus('Avan√ßando para pr√≥xima m√∫sica');
            });
        }
        
        // Alternar shuffle
        function toggleShuffle() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            const newShuffleState = !shuffleBtn.classList.contains('active');
            
            fetch(`https://api.spotify.com/v1/me/player/shuffle?state=${newShuffleState}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`
                }
            }).then(() => {
                shuffleBtn.classList.toggle('active', newShuffleState);
                updateStatus(newShuffleState ? 'Shuffle ativado' : 'Shuffle desativado');
            }).catch(error => {
                console.error('Error toggling shuffle:', error);
            });
        }
        
        // Alternar repeat
        function toggleRepeat() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            const currentState = repeatBtn.dataset.state || 'off';
            let newState;
            
            if (currentState === 'off') {
                newState = 'context';
            } else if (currentState === 'context') {
                newState = 'track';
            } else {
                newState = 'off';
            }
            
            fetch(`https://api.spotify.com/v1/me/player/repeat?state=${newState}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`
                }
            }).then(() => {
                repeatBtn.dataset.state = newState;
                updateRepeatButton(newState);
                updateStatus(getRepeatStatusMessage(newState));
            }).catch(error => {
                console.error('Error toggling repeat:', error);
            });
        }
        
        // Atualizar bot√£o de repeat
        function updateRepeatButton(state) {
            repeatBtn.dataset.state = state;
            
            switch(state) {
                case 0: // off
                    repeatBtn.textContent = 'üîÅ';
                    repeatBtn.style.opacity = '0.5';
                    break;
                case 1: // context (playlist)
                    repeatBtn.textContent = 'üîÅ';
                    repeatBtn.style.opacity = '1';
                    break;
                case 2: // track
                    repeatBtn.textContent = 'üîÇ';
                    repeatBtn.style.opacity = '1';
                    break;
            }
        }
        
        // Mensagem de status para repeat
        function getRepeatStatusMessage(state) {
            switch(state) {
                case 0: return 'Repeti√ß√£o desativada';
                case 1: return 'Repetir playlist ativado';
                case 2: return 'Repetir m√∫sica ativado';
                default: return '';
            }
        }
        
        // Atualizar volume
        function updateVolume() {
            const volume = parseFloat(volumeSlider.value);
            playerState.volume = volume;
            
            if (playerState.player) {
                playerState.player.setVolume(volume).then(() => {
                    console.log('Volume atualizado:', volume);
                });
            }
        }
        
        // Atualizar UI do player
        function updatePlayerUI() {
            if (playerState.currentTrack) {
                trackName.textContent = playerState.currentTrack.name;
                trackArtist.textContent = playerState.currentTrack.artists.map(a => a.name).join(', ');
                trackCover.src = playerState.currentTrack.album.images[0]?.url || 'https://via.placeholder.com/50';
                playBtn.textContent = playerState.isPlaying ? '‚è∏' : '‚ñ∂';
            } else {
                trackName.textContent = 'Nenhuma m√∫sica tocando';
                trackArtist.textContent = '‚Äî';
                trackCover.src = 'https://via.placeholder.com/50';
                playBtn.textContent = '‚ñ∂';
            }
        }
        
        // Atualizar barra de progresso
        function updateProgress(position, duration) {
            if (playerState.progressInterval) {
                clearInterval(playerState.progressInterval);
            }
            
            if (!duration) {
                progressBar.style.width = '0%';
                return;
            }
            
            // Atualizar posi√ß√£o inicial
            const updateProgressBar = () => {
                const progressPercent = (position / duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                
                if (playerState.isPlaying && position < duration) {
                    position += 1000; // Incrementar 1 segundo
                }
            };
            
            updateProgressBar();
            playerState.progressInterval = setInterval(updateProgressBar, 1000);
        }
        
        // Atualizar mensagem de status
        function updateStatus(message) {
            statusMessage.textContent = message;
        }
        
        // Atualizar status do dispositivo
        function updateDeviceStatus(message) {
            deviceStatus.textContent = message;
        }
        
        // Inicializar quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
