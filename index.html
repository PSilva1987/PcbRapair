<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Web Playback SDK Example</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: white;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            color: #1DB954;
            text-align: center;
        }
        
        .player-container {
            background-color: #181818;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .track-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .album-cover {
            width: 150px;
            height: 150px;
            border-radius: 5px;
            margin-right: 20px;
        }
        
        .track-details h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .track-details p {
            margin: 5px 0 0;
            color: #b3b3b3;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .progress-container {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 5px;
            background-color: #535353;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .progress {
            height: 100%;
            background-color: #1DB954;
            border-radius: 5px;
            width: 0%;
        }
        
        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #b3b3b3;
        }
        
        button {
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            margin: 0 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:disabled {
            background-color: #535353;
            cursor: not-allowed;
        }
        
        .secondary-btn {
            background-color: transparent;
            color: #b3b3b3;
            font-size: 24px;
        }
        
        .auth-container {
            text-align: center;
            margin-top: 50px;
        }
        
        .auth-btn {
            background-color: #1DB954;
            color: white;
            border: none;
            border-radius: 500px;
            padding: 12px 32px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .device-status {
            text-align: center;
            margin-top: 20px;
            color: #b3b3b3;
        }
        
        .status-message {
            text-align: center;
            margin-top: 20px;
            color: #b3b3b3;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Spotify Web Playback SDK</h1>
        
        <div id="auth-container" class="auth-container">
            <button id="auth-btn" class="auth-btn">Login with Spotify</button>
        </div>
        
        <div id="player-container" class="player-container" style="display: none;">
            <div class="track-info">
                <img id="album-cover" class="album-cover" src="https://via.placeholder.com/150" alt="Album Cover">
                <div class="track-details">
                    <h2 id="track-name">Not Playing</h2>
                    <p id="track-artist">‚Äî</p>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress" id="progress-bar"></div>
                </div>
                <div class="time-info">
                    <span id="current-time">0:00</span>
                    <span id="duration">0:00</span>
                </div>
            </div>
            
            <div class="controls">
                <button id="shuffle-btn" class="secondary-btn" title="Shuffle">üîÄ</button>
                <button id="prev-btn" class="secondary-btn" title="Previous">‚èÆ</button>
                <button id="play-btn" title="Play">‚ñ∂</button>
                <button id="next-btn" class="secondary-btn" title="Next">‚è≠</button>
                <button id="repeat-btn" class="secondary-btn" title="Repeat">üîÅ</button>
            </div>
            
            <div class="device-status" id="device-status">
                Device: Not connected
            </div>
        </div>
        
        <div class="status-message" id="status-message"></div>
    </div>

    <script>
        // Configuration
        const clientId = 'a320634e6ebf4bb58de016369cf5b1a1'; // Replace with your client ID
        const redirectUri = 'https://psilva1987.github.io/PcbRapair';
        
        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const authBtn = document.getElementById('auth-btn');
        const playerContainer = document.getElementById('player-container');
        const albumCover = document.getElementById('album-cover');
        const trackName = document.getElementById('track-name');
        const trackArtist = document.getElementById('track-artist');
        const progressBar = document.getElementById('progress-bar');
        const currentTime = document.getElementById('current-time');
        const duration = document.getElementById('duration');
        const playBtn = document.getElementById('play-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const deviceStatus = document.getElementById('device-status');
        const statusMessage = document.getElementById('status-message');
        
        // Player state
        const playerState = {
            accessToken: null,
            deviceId: null,
            player: null,
            isPlaying: false,
            currentTrack: null,
            progressInterval: null,
            volume: 0.5,
            position: 0,
            duration: 0,
            repeatMode: 0, // 0 = off, 1 = context, 2 = track
            isShuffled: false
        };
        
        // Initialize the app
        function init() {
            // Check for access token in URL (after redirect from Spotify)
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            // Clear the URL after getting the token
            if (accessToken) {
                history.replaceState(null, null, ' ');
                playerState.accessToken = accessToken;
                authContainer.style.display = 'none';
                playerContainer.style.display = 'block';
                setupWebPlaybackSDK();
            }
            
            setupEventListeners();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            authBtn.addEventListener('click', authenticateWithSpotify);
            playBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', playPrevious);
            nextBtn.addEventListener('click', playNext);
            shuffleBtn.addEventListener('click', toggleShuffle);
            repeatBtn.addEventListener('click', toggleRepeat);
        }
        
        // Authenticate with Spotify
        function authenticateWithSpotify() {
            const scopes = [
                'streaming',
                'user-read-email',
                'user-read-private',
                'user-read-playback-state',
                'user-modify-playback-state'
            ];
            
            const authUrl = new URL('https://accounts.spotify.com/authorize');
            const params = {
                response_type: 'token',
                client_id: clientId,
                scope: scopes.join(' '),
                redirect_uri: redirectUri,
                show_dialog: 'true'
            };
            
            Object.keys(params).forEach(key => {
                authUrl.searchParams.append(key, params[key]);
            });
            
            statusMessage.textContent = 'Redirecting to Spotify authentication...';
            window.location.href = authUrl.toString();
        }
        
        // Setup Web Playback SDK
        function setupWebPlaybackSDK() {
            statusMessage.textContent = 'Connecting to Spotify...';
            
            // Load the Web Playback SDK script
            const script = document.createElement('script');
            script.src = 'https://sdk.scdn.co/spotify-player.js';
            script.onload = () => {
                window.onSpotifyWebPlaybackSDKReady = () => {
                    playerState.player = new Spotify.Player({
                        name: 'Web Playback SDK Example',
                        getOAuthToken: cb => { cb(playerState.accessToken); },
                        volume: playerState.volume
                    });
                    
                    // Setup player event listeners
                    setupPlayerListeners();
                    
                    // Connect to the player
                    playerState.player.connect().then(success => {
                        if (success) {
                            statusMessage.textContent = 'Connected successfully! Play something on your Spotify app and select this device.';
                        } else {
                            statusMessage.textContent = 'Failed to connect to player. Please try again.';
                        }
                    });
                };
            };
            document.body.appendChild(script);
        }
        
        // Setup player event listeners
        function setupPlayerListeners() {
            // Ready
            playerState.player.addListener('ready', ({ device_id }) => {
                playerState.deviceId = device_id;
                deviceStatus.textContent = `Device: ${device_id.substring(0, 8)}...`;
                transferPlayback(device_id);
            });
            
            // Player state changed
            playerState.player.addListener('player_state_changed', state => {
                if (!state) {
                    statusMessage.textContent = 'No track currently playing. Play something on your Spotify app.';
                    playerState.isPlaying = false;
                    playerState.currentTrack = null;
                    updatePlayerUI();
                    return;
                }
                
                playerState.isPlaying = !state.paused;
                playerState.currentTrack = state.track_window.current_track;
                playerState.position = state.position;
                playerState.duration = state.duration;
                playerState.isShuffled = state.shuffle;
                playerState.repeatMode = state.repeat_mode;
                
                updatePlayerUI();
                updateProgressBar();
                updateControlStates();
            });
            
            // Error handling
            playerState.player.addListener('initialization_error', ({ message }) => {
                console.error('Initialization Error:', message);
                statusMessage.textContent = `Initialization Error: ${message}`;
            });
            
            playerState.player.addListener('authentication_error', ({ message }) => {
                console.error('Authentication Error:', message);
                statusMessage.textContent = `Authentication Error: ${message}`;
                playerState.accessToken = null;
                authContainer.style.display = 'block';
                playerContainer.style.display = 'none';
            });
            
            playerState.player.addListener('account_error', ({ message }) => {
                console.error('Account Error:', message);
                statusMessage.textContent = `Account Error: ${message}`;
            });
            
            playerState.player.addListener('playback_error', ({ message }) => {
                console.error('Playback Error:', message);
                statusMessage.textContent = `Playback Error: ${message}`;
            });
            
            // Disconnected
            playerState.player.addListener('not_ready', ({ device_id }) => {
                console.log('Device ID has gone offline', device_id);
                deviceStatus.textContent = `Device offline: ${device_id.substring(0, 8)}...`;
            });
        }
        
        // Transfer playback to this device
        function transferPlayback(deviceId) {
            fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    device_ids: [deviceId],
                    play: false
                })
            }).then(() => {
                statusMessage.textContent = 'Ready to play! Select this device in your Spotify app.';
            }).catch(error => {
                console.error('Error transferring playback:', error);
                statusMessage.textContent = 'Error transferring playback. Make sure Spotify is open on another device.';
            });
        }
        
        // Toggle play/pause
        function togglePlay() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            if (playerState.isPlaying) {
                playerState.player.pause().then(() => {
                    statusMessage.textContent = 'Playback paused';
                });
            } else {
                playerState.player.resume().then(() => {
                    statusMessage.textContent = 'Playback resumed';
                });
            }
        }
        
        // Play previous track
        function playPrevious() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            playerState.player.previousTrack().then(() => {
                statusMessage.textContent = 'Playing previous track';
            });
        }
        
        // Play next track
        function playNext() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            playerState.player.nextTrack().then(() => {
                statusMessage.textContent = 'Playing next track';
            });
        }
        
        // Toggle shuffle
        function toggleShuffle() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            const newShuffleState = !playerState.isShuffled;
            
            fetch(`https://api.spotify.com/v1/me/player/shuffle?state=${newShuffleState}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`
                }
            }).then(() => {
                playerState.isShuffled = newShuffleState;
                shuffleBtn.style.color = newShuffleState ? '#1DB954' : '#b3b3b3';
                statusMessage.textContent = newShuffleState ? 'Shuffle enabled' : 'Shuffle disabled';
            }).catch(error => {
                console.error('Error toggling shuffle:', error);
                statusMessage.textContent = 'Error toggling shuffle';
            });
        }
        
        // Toggle repeat
        function toggleRepeat() {
            if (!playerState.accessToken) {
                authenticateWithSpotify();
                return;
            }
            
            let newRepeatMode;
            
            switch(playerState.repeatMode) {
                case 0: // off ‚Üí context
                    newRepeatMode = 1;
                    break;
                case 1: // context ‚Üí track
                    newRepeatMode = 2;
                    break;
                case 2: // track ‚Üí off
                    newRepeatMode = 0;
                    break;
            }
            
            fetch(`https://api.spotify.com/v1/me/player/repeat?state=${getRepeatStateString(newRepeatMode)}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${playerState.accessToken}`
                }
            }).then(() => {
                playerState.repeatMode = newRepeatMode;
                updateRepeatButton();
                statusMessage.textContent = getRepeatStatusMessage(newRepeatMode);
            }).catch(error => {
                console.error('Error toggling repeat:', error);
                statusMessage.textContent = 'Error toggling repeat';
            });
        }
        
        // Convert repeat mode to string
        function getRepeatStateString(mode) {
            switch(mode) {
                case 0: return 'off';
                case 1: return 'context';
                case 2: return 'track';
            }
        }
        
        // Get repeat status message
        function getRepeatStatusMessage(mode) {
            switch(mode) {
                case 0: return 'Repeat disabled';
                case 1: return 'Repeat playlist enabled';
                case 2: return 'Repeat track enabled';
            }
        }
        
        // Update repeat button appearance
        function updateRepeatButton() {
            switch(playerState.repeatMode) {
                case 0:
                    repeatBtn.textContent = 'üîÅ';
                    repeatBtn.style.color = '#b3b3b3';
                    break;
                case 1:
                    repeatBtn.textContent = 'üîÅ';
                    repeatBtn.style.color = '#1DB954';
                    break;
                case 2:
                    repeatBtn.textContent = 'üîÇ';
                    repeatBtn.style.color = '#1DB954';
                    break;
            }
        }
        
        // Update control button states
        function updateControlStates() {
            shuffleBtn.style.color = playerState.isShuffled ? '#1DB954' : '#b3b3b3';
            updateRepeatButton();
        }
        
        // Update player UI
        function updatePlayerUI() {
            if (playerState.currentTrack) {
                trackName.textContent = playerState.currentTrack.name;
                trackArtist.textContent = playerState.currentTrack.artists.map(a => a.name).join(', ');
                albumCover.src = playerState.currentTrack.album.images[0]?.url || 'https://via.placeholder.com/150';
                playBtn.textContent = playerState.isPlaying ? '‚è∏' : '‚ñ∂';
            } else {
                trackName.textContent = 'Not Playing';
                trackArtist.textContent = '‚Äî';
                albumCover.src = 'https://via.placeholder.com/150';
                playBtn.textContent = '‚ñ∂';
            }
        }
        
        // Update progress bar
        function updateProgressBar() {
            if (playerState.progressInterval) {
                clearInterval(playerState.progressInterval);
            }
            
            if (!playerState.duration) {
                progressBar.style.width = '0%';
                currentTime.textContent = '0:00';
                duration.textContent = '0:00';
                return;
            }
            
            // Format time (ms ‚Üí mm:ss)
            const formatTime = (ms) => {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            };
            
            // Initial update
            const update = () => {
                const progressPercent = (playerState.position / playerState.duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                currentTime.textContent = formatTime(playerState.position);
                duration.textContent = formatTime(playerState.duration);
                
                if (playerState.isPlaying && playerState.position < playerState.duration) {
                    playerState.position += 1000; // Increment by 1 second
                }
            };
            
            update();
            
            // Update every second if playing
            if (playerState.isPlaying) {
                playerState.progressInterval = setInterval(update, 1000);
            }
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
